# Azure DevOps Pipeline for Databricks ML Model Deployment with Monitoring
# Customize trigger branches and variable groups for your project

trigger:
  branches:
    include:
      - main
      - develop
      # Add your branch patterns here

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: databricks-secrets-dev  # Update with your variable group name
  - group: databricks-secrets-aut  # Update with your variable group name
  - group: databricks-secrets-prod # Update with your variable group name

stages:
  - stage: Build
    displayName: 'Build Package'
    jobs:
      - job: BuildPackage
        displayName: 'Build Wheel Package'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python 3.12'
            inputs:
              versionSpec: '3.12'

          - script: |
              python -m pip install --upgrade pip
              pip install uv
            displayName: 'Install UV Package Manager'

          - script: |
              uv build
            displayName: 'Build Wheel Package'

          - publish: dist/
            artifact: wheel-package
            displayName: 'Publish Wheel Artifact'

  - stage: Test
    displayName: 'Run Tests'
    dependsOn: Build
    jobs:
      - job: RunTests
        displayName: 'Run Unit Tests and Linting'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python 3.12'
            inputs:
              versionSpec: '3.12'

          - script: |
              pip install uv
              uv sync --extra dev
            displayName: 'Install Dependencies'

          - script: |
              uv run pytest tests/ -v --cov=src --cov-report=xml --cov-report=term
            displayName: 'Run Tests with Coverage'
            continueOnError: true

          - script: |
              uv run ruff check src/
            displayName: 'Run Ruff Linting'

          - task: PublishCodeCoverageResults@1
            displayName: 'Publish Code Coverage'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage.xml'
            condition: succeededOrFailed()

  - stage: DeployDev
    displayName: 'Deploy to Dev'
    dependsOn: Test
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
      - deployment: DeployToDev
        displayName: 'Deploy to Development Environment'
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: UsePythonVersion@0
                  displayName: 'Use Python 3.12'
                  inputs:
                    versionSpec: '3.12'

                - task: AzureCLI@2
                  displayName: 'Authenticate with Azure AD'
                  inputs:
                    azureSubscription: 'Azure-ServiceConnection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Get Azure AD token for Databricks
                      echo "##vso[task.setvariable variable=DATABRICKS_TOKEN]$(az account get-access-token --resource 2ff814a6-3304-4ab8-85cb-cd0e6f879c1d --query accessToken -o tsv)"

                - script: |
                    pip install databricks-cli
                  displayName: 'Install Databricks CLI'

                - script: |
                    databricks bundle deploy --target dev \
                      --var="git_sha=$(Build.SourceVersion)" \
                      --var="branch=$(Build.SourceBranchName)"
                  displayName: 'Deploy Bundle to Dev'
                  env:
                    DATABRICKS_HOST: $(DATABRICKS_HOST_DEV)
                    DATABRICKS_TOKEN: $(DATABRICKS_TOKEN)

  - stage: DeployAut
    displayName: 'Deploy to Aut'
    dependsOn: DeployDev
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
      - deployment: DeployToAut
        displayName: 'Deploy to Acceptance Environment'
        environment: 'aut'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: UsePythonVersion@0
                  displayName: 'Use Python 3.12'
                  inputs:
                    versionSpec: '3.12'

                - task: AzureCLI@2
                  displayName: 'Authenticate with Azure AD'
                  inputs:
                    azureSubscription: 'Azure-ServiceConnection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Get Azure AD token for Databricks
                      echo "##vso[task.setvariable variable=DATABRICKS_TOKEN]$(az account get-access-token --resource 2ff814a6-3304-4ab8-85cb-cd0e6f879c1d --query accessToken -o tsv)"

                - script: |
                    pip install databricks-cli
                  displayName: 'Install Databricks CLI'

                - script: |
                    databricks bundle deploy --target aut \
                      --var="git_sha=$(Build.SourceVersion)" \
                      --var="branch=$(Build.SourceBranchName)"
                  displayName: 'Deploy Bundle to Aut'
                  env:
                    DATABRICKS_HOST: $(DATABRICKS_HOST_AUT)
                    DATABRICKS_TOKEN: $(DATABRICKS_TOKEN)

  - stage: DeployProd
    displayName: 'Deploy to Production'
    dependsOn: Test
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToProd
        displayName: 'Deploy to Production Environment'
        environment: 'prod'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: UsePythonVersion@0
                  displayName: 'Use Python 3.12'
                  inputs:
                    versionSpec: '3.12'

                - task: AzureCLI@2
                  displayName: 'Authenticate with Azure AD'
                  inputs:
                    azureSubscription: 'Azure-ServiceConnection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Get Azure AD token for Databricks
                      echo "##vso[task.setvariable variable=DATABRICKS_TOKEN]$(az account get-access-token --resource 2ff814a6-3304-4ab8-85cb-cd0e6f879c1d --query accessToken -o tsv)"

                - script: |
                    pip install databricks-cli
                  displayName: 'Install Databricks CLI'

                - script: |
                    databricks bundle deploy --target prod \
                      --var="git_sha=$(Build.SourceVersion)" \
                      --var="branch=$(Build.SourceBranchName)"
                  displayName: 'Deploy Bundle to Production'
                  env:
                    DATABRICKS_HOST: $(DATABRICKS_HOST_PRD)
                    DATABRICKS_TOKEN: $(DATABRICKS_TOKEN)

                - script: |
                    git tag -a "v$(cat version.txt)" -m "Production release $(Build.SourceVersion)"
                    git push origin "v$(cat version.txt)"
                  displayName: 'Create and Push Git Tag'
                  condition: succeeded()
